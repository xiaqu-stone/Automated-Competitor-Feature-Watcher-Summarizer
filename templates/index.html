{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 mb-4">
            <i class="bi bi-robot"></i> ACFWS ç«å“åŠŸèƒ½ç›‘æ§
        </h1>
        <p class="lead mb-4">
            AIé©±åŠ¨çš„è‡ªåŠ¨åŒ–ç«å“åŠŸèƒ½å‘ç°ä¸åˆ†æç³»ç»Ÿ
        </p>
        <p class="mb-0">
            å®æ—¶ç›‘æ§ Grabã€FoodPandaã€Feedme ç­‰ç«å“çš„æœ€æ–°åŠŸèƒ½å‘å¸ƒ
        </p>
    </div>
</section>

<!-- Dashboard Section -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Status Card -->
            <div class="col-md-6 mb-4">
                <div class="card card-dashboard h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-activity"></i> ç³»ç»ŸçŠ¶æ€
                        </h5>
                        <div class="mb-3">
                            <span id="status-display" class="badge badge-lg status-{{ state.status }}">
                                {% if state.status == 'ready' %}
                                    <i class="bi bi-check-circle"></i> å‡†å¤‡å°±ç»ª
                                {% elif state.status == 'running' %}
                                    <i class="bi bi-arrow-repeat spin"></i> åˆ†æä¸­
                                {% elif state.status == 'completed' %}
                                    <i class="bi bi-check-circle-fill"></i> å·²å®Œæˆ
                                {% elif state.status == 'error' %}
                                    <i class="bi bi-x-circle"></i> é”™è¯¯
                                {% endif %}
                            </span>
                        </div>
                        
                        <!-- Progress Bar (shown when running) -->
                        <div id="progress-container" style="{% if state.status != 'running' %}display: none;{% endif %}">
                            <div class="progress mb-2">
                                <div id="progress-bar" class="progress-bar" 
                                     style="width: {{ (state.processed_articles / state.total_articles * 100) if state.total_articles > 0 else 0 }}%">
                                    {{ state.processed_articles }}/{{ state.total_articles }}
                                </div>
                            </div>
                            <small id="current-task" class="text-muted">{{ state.current_task }}</small>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-3">
                            {% if state.status == 'ready' or state.status == 'completed' or state.status == 'error' %}
                                <button id="start-analysis" class="btn btn-primary btn-lg">
                                    <i class="bi bi-play-fill"></i> å¼€å§‹åˆ†æ
                                </button>
                            {% else %}
                                <button class="btn btn-secondary btn-lg" disabled>
                                    <i class="bi bi-hourglass-split"></i> åˆ†æä¸­...
                                </button>
                                <a href="/monitor" class="btn btn-info btn-sm ms-2">
                                    <i class="bi bi-display"></i> æŸ¥çœ‹å®æ—¶ç›‘æ§
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats Card -->
            <div class="col-md-6 mb-4">
                <div class="card card-dashboard h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-graph-up"></i> å¿«é€Ÿç»Ÿè®¡
                        </h5>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-item">
                                    <h3 class="text-primary">{{ state.results|length }}</h3>
                                    <small class="text-muted">å·²åˆ†ææ–‡ç« </small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-item">
                                    <h3 class="text-success">
                                        {{ state.results|selectattr('is_new_feature')|list|length }}
                                    </h3>
                                    <small class="text-muted">æ–°åŠŸèƒ½å‘ç°</small>
                                </div>
                            </div>
                        </div>
                        
                        {% if state.start_time %}
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> 
                                æœ€åè¿è¡Œ: {{ state.start_time.strftime('%Y-%m-%d %H:%M') if state.start_time else 'æœªè¿è¡Œ' }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Results Preview -->
        {% if state.results %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> æœ€æ–°å‘ç°
                        </h5>
                        <a href="/results" class="btn btn-outline-primary btn-sm">
                            æŸ¥çœ‹å…¨éƒ¨ç»“æœ <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for result in state.results[-3:] %}
                            <div class="col-md-4 mb-3">
                                <div class="card feature-card {% if result.is_new_feature %}feature-new{% endif %} h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            {% if result.is_new_feature %}
                                                <span class="badge bg-warning text-dark me-2">ğŸš€ æ–°åŠŸèƒ½</span>
                                            {% endif %}
                                            {{ result.title[:50] }}...
                                        </h6>
                                        <p class="card-text text-muted small">
                                            {{ result.summary[:100] }}...
                                        </p>
                                        <small class="text-muted">
                                            <i class="bi bi-link-45deg"></i> 
                                            <a href="{{ result.url }}" target="_blank">æŸ¥çœ‹åŸæ–‡</a>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<script>
// Auto-refresh status every 5 seconds when analysis is running
if ('{{ state.status }}' === 'running') {
    setInterval(function() {
        location.reload();
    }, 5000);
}

// Start analysis button handler
document.getElementById('start-analysis')?.addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> å¯åŠ¨ä¸­...';
    
    fetch('/start_analysis', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/monitor';
        } else {
            alert('å¯åŠ¨å¤±è´¥: ' + data.message);
            location.reload();
        }
    })
    .catch(error => {
        alert('ç½‘ç»œé”™è¯¯: ' + error);
        location.reload();
    });
});
</script>
{% endblock %} 